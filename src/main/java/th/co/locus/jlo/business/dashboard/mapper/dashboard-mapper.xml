<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dashboard">
	<select id="getCountCaseEachStatus" resultType="DashboardBean">

		SELECT
		  count(IF(c.STATUS ='01',1,NULL)) as countNew ,
		  count(IF(c.STATUS ='02',1,NULL)) as countWorking,
		  count(IF(c.STATUS ='03',1,NULL)) as countEscalated,
		  count(IF(c.STATUS ='04',1,NULL)) as countClosed 
		FROM loy_case c 
		<where>
			<if test="ownerId != null and ownerId != ''"> 
				and c.OWNER = #{ownerId}
			</if>
			<if test="orgId != null and orgId != ''"> 
				and c.OWNER = #{orgId}
			</if>
		</where>
	</select>
	
	<select id="getCaseDashboardList" resultType="CaseModelBean">
		SELECT 		
			IFNULL(LMB.FIRST_NAME, TCM.FIRST_NAME) AS FIRST_NAME,
			IFNULL(LMB.LAST_NAME, TCM.LAST_NAME) AS LAST_NAME,
			IFNULL(LMB.BUSINESS_NAME, TCM.BUSINESS_NAME) AS BUSINESS_NAME,
			IFNULL(LMB.MEMBER_TYPE, TCM.CUSTOMER_TYPE) AS MEMBER_TYPE,
			IFNULL(LMB.TITLE, TCM.TITLE) AS TITLE,
			IFNULL(LMB.PHONE_NO, TCM.PHONE_NO) AS PHONE_NO,
			IFNULL(LMB.EMAIL, TCM.EMAIL) AS EMAIL,
		    LC.CASE_NUMBER,
			LC.DETAIL,
		    LC.TYPE,
			LC.SUBTYPE,
		    LC.PRIORITY,
		    LC.STATUS,
		    LC.CHANNEL,
		    LC.OWNER,
		    LC.SUBJECT,
		    LC.OPENED_DATE,
		    LC.CLOSED_DATE,
		    LC.BU_ID,
		    LC.CUSTOMER_ID,
		    
			CONCAT(COALESCE(u1.FIRST_NAME,''), ' ',COALESCE(u1.LAST_NAME,'')) AS createdBy,
			LC.CREATED_DATE AS createdDate ,
            CONCAT(COALESCE(u2.FIRST_NAME,''), ' ',COALESCE( u2.LAST_NAME,'')) AS updatedBy,
			LC.UPDATED_DATE AS updatedDate,
            
            CONCAT(USR.FIRST_NAME,' ',USR.LAST_NAME) AS displayName,
            CB1.CODE_NAME AS typeName,
            CB2.CODE_NAME AS subTypeName,
            CB3.CODE_NAME AS priorityName
		FROM
		    LOY_CASE LC
            INNER JOIN TB_USER USR ON LC.OWNER = USR.ID
			INNER JOIN TB_CODEBOOK CB1 ON LC.TYPE = CB1.CODE_ID AND CB1.CODE_TYPE = 'CASE_TYPE'
	        INNER JOIN TB_CODEBOOK CB2 ON LC.SUBTYPE = CB2.CODE_ID AND CB2.CODE_TYPE = 'CASE_SUBTYPE'
	        INNER JOIN TB_CODEBOOK CB3 ON LC.PRIORITY = CB3.CODE_ID AND CB3.CODE_TYPE = 'CASE_PRIORITY'
            INNER JOIN TB_CUSTOMER TCM ON LC.CUSTOMER_ID = TCM.CUSTOMER_ID
            LEFT JOIN LOY_MEMBER LMB ON LC.CUSTOMER_ID = LMB.CUSTOMER_ID
			LEFT JOIN TB_USER u1 ON LC.CREATED_BY = u1.ID
			LEFT JOIN TB_USER u2 ON LC.UPDATED_BY = u2.ID
		<where>
			<if test="ownerId != null and ownerId != ''">
				AND LC.OWNER = #{ownerId}
			</if>
			<if test="orgId != null and orgId != ''"> 
				and c.OWNER = #{orgId}
			</if>	
		</where>
		ORDER BY LC.CASE_NUMBER DESC 
	</select>

	
	
</mapper>