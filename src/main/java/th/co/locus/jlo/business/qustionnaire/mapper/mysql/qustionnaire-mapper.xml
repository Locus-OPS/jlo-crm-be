<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="questionnaire">
	
	<select id="getHeaderQuestionaireList" resultType="QuestionnaireHeaderModelBean">
		SELECT 
		hd.ID
		, hd.QUESTIONNAIRE_TYPE
		, hd.FORM_NAME
		, hd.SECTION_HEADER_TEXT
		, hd.STATUS_CD
		, hd.BU_ID
		, hd.CREATED_DATE
		, hd.CREATED_BY
		, hd.UPDATED_DATE
		, hd.UPDATED_BY
		, concat(cr.FIRST_NAME,' ',cr.LAST_NAME) AS createdByName
		, concat(upd.FIRST_NAME,' ',upd.LAST_NAME) AS updatedByName
		FROM tb_questionnaire_header hd
		LEFT JOIN tb_user cr  on hd.CREATED_BY =cr.ID 
		LEFT JOIN tb_user upd on hd.UPDATED_BY = upd.ID 
		WHERE hd.STATUS_CD=#{statusCd}
		<if test="formName!=null and formName!=''">
			<bind name="bformName" value="'%' + formName + '%'" />
			AND hd.FORM_NAME like #{bformName}
		</if>
		<if test="questionnaireType!=null and questionnaireType!=''">
			AND hd.QUESTIONNAIRE_TYPE=#{questionnaireType}
		</if>
		ORDER BY hd.CREATED_DATE DESC
	</select>

	<select id="findQuestionnaireById" resultType="QuestionnaireHeaderModelBean">
		SELECT 
		hd.ID
		, hd.QUESTIONNAIRE_TYPE
		, hd.FORM_NAME
		, hd.SECTION_HEADER_TEXT
		, hd.STATUS_CD
		, hd.BU_ID
		, hd.CREATED_DATE
		, hd.CREATED_BY
		, hd.UPDATED_DATE
		, hd.UPDATED_BY
		, concat(cr.FIRST_NAME,' ',cr.LAST_NAME) AS createdByName
		, concat(upd.FIRST_NAME,' ',upd.LAST_NAME) AS updatedByName
		FROM tb_questionnaire_header hd
		LEFT JOIN tb_user cr  on hd.CREATED_BY =cr.ID 
		LEFT JOIN tb_user upd on hd.UPDATED_BY = upd.ID 
		WHERE hd.ID=#{id}
	</select>
	
	<insert id="createHeaderQuestionnaire" keyColumn="ID" keyProperty="id" useGeneratedKeys="true">
	    INSERT INTO `tb_questionnaire_header`
	    (
	        `QUESTIONNAIRE_TYPE`,
	        `FORM_NAME`,
	        `SECTION_HEADER_TEXT`,
	        `STATUS_CD`,
	        `BU_ID`,
	        `CREATED_DATE`,
	        `CREATED_BY`,
	        `UPDATED_DATE`,
	        `UPDATED_BY`
	    )
	    VALUES
	    (
	        #{questionnaireType},
	        #{formName},
	        #{sectionHeaderText},
	        #{statusCd},
	        #{buId},
	        NOW(),
	        #{createdBy},
	        NOW(),
	        #{updatedBy}
	    )
	</insert>

	
	<update id="updateHeaderQuestionnaire">
		UPDATE  `tb_questionnaire_header`
			SET
			`QUESTIONNAIRE_TYPE` = #{questionnaireType},
			`FORM_NAME` =#{formName},
			`SECTION_HEADER_TEXT` = #{sectionHeaderText},
			`STATUS_CD` = #{statusCd},
			`UPDATED_DATE` = NOW(),
			`UPDATED_BY` = #{updatedBy}
			WHERE `ID` = #{id};
	</update>
	
	<select id="getQuestionnaireQuestionList" resultType="QuestionnaireQuestionModelBean">
		SELECT 
		q.ID
		, q.HEADER_ID
		, q.QUESTION
		, q.ANSWER_TYPE
		, anstype.CODE_NAME  as answerTypename
		, q.OPTIONS
		, q.DESCRIPTION
		, q.IMAGE_URL
		, q.STATUS_CD
		, q.REQUIRED_FLG
		, q.SEQ_NO
		, q.BU_ID
		, q.CREATED_DATE
		, q.CREATED_BY
		, concat(cr.FIRST_NAME,' ',cr.LAST_NAME) as createdByName 
		, q.UPDATED_DATE
		, q.UPDATED_BY
		, concat(upd.FIRST_NAME,' ',upd.LAST_NAME) as updatedByName
		, anstype.ETC1  as componentType
		FROM tb_questionnaire_q_master q
		left join tb_codebook anstype on q.ANSWER_TYPE = anstype.CODE_ID and anstype.CODE_TYPE ='ANSWER_TYPE'
		left join tb_user cr on q.CREATED_BY = cr.USER_ID 
		left join tb_user upd on q.UPDATED_BY =upd.USER_ID 
		where q.HEADER_ID=#{headerId}
		and q.STATUS_CD='Y'
		ORDER BY q.SEQ_NO
	</select>
	<select id="getQuestionnairequestionDetail" resultType="QuestionnaireQuestionModelBean">
		SELECT 
		q.ID
		, q.HEADER_ID
		, q.QUESTION
		, q.ANSWER_TYPE
		, q.OPTIONS
		, q.DESCRIPTION
		, q.IMAGE_URL
		, q.STATUS_CD
		, q.REQUIRED_FLG
		, q.SEQ_NO
		, q.BU_ID
		, q.CREATED_DATE
		, q.CREATED_BY
		, concat(cr.FIRST_NAME,' ',cr.LAST_NAME) as createdByName 
		, q.UPDATED_DATE
		, q.UPDATED_BY
		,concat(upd.FIRST_NAME,' ',upd.LAST_NAME) as updatedByName
		FROM tb_questionnaire_q_master q
		left join tb_user cr on q.CREATED_BY = cr.USER_ID 
		left join tb_user upd on q.UPDATED_BY =upd.USER_ID 
		where q.ID=#{id}
	</select>
	
	<insert id="createQuestionnaireQuestion" keyColumn="ID" keyProperty="id" useGeneratedKeys="true">
	    INSERT INTO tb_questionnaire_q_master
		( HEADER_ID
		, QUESTION
		, ANSWER_TYPE
		, OPTIONS
		, DESCRIPTION
		, IMAGE_URL
		, STATUS_CD
		, REQUIRED_FLG
		, SEQ_NO
		, BU_ID
		, CREATED_DATE
		, CREATED_BY
		, UPDATED_DATE
		, UPDATED_BY
		)
		VALUES(
		#{headerId}
		, #{question}
		, #{answerType}
		, #{options}
		, #{description}
		, #{imageUrl}
		, #{statusCd}
		, #{requiredFlg}
		, #{seqNo}
		, #{buId}
		, NOW()
		, #{createdBy}
		, NOW()
		, #{updatedBy}
		)
	</insert>
	
	<update id="updateQuestionnaireQuestion">
		UPDATE tb_questionnaire_q_master
		SET 
		  QUESTION=#{question}
		, ANSWER_TYPE=#{answerType}
		, OPTIONS=#{options}
		, DESCRIPTION=#{description}
		, IMAGE_URL=#{imageUrl}
		, STATUS_CD=#{statusCd}
		, REQUIRED_FLG=#{requiredFlg}
		, SEQ_NO=#{seqNo}
		, BU_ID=#{buId}
		, UPDATED_DATE=NOW()
		, UPDATED_BY=#{updatedBy}
		WHERE ID=#{id}
	</update>
	
	<select id="getQuestionnaireAnswerList" resultType="QuestionnaireAnswerModelBean">
		SELECT 
		ans.ID
		, hd.ID as HEADER_ID
		, ans.QUESTION_ID
		, q.QUESTION 
		, ans.ANSWER
		, ans.STATUS_CD
		, ans.SEQ_NO
		, ans.BU_ID
		, ans.CREATED_DATE
		, ans.CREATED_BY
		, ans.UPDATED_DATE
		, ans.UPDATED_BY
		FROM tb_questionnaire_ans_master ans
		join tb_questionnaire_q_master q on ans.QUESTION_ID = q.ID 
		join tb_questionnaire_header hd on q.HEADER_ID = hd.ID 
		where  hd.ID =#{headerId}
		and hd.STATUS_CD ='Y' and q.STATUS_CD ='Y' and ans.STATUS_CD ='Y'
		order by ans.ID,hd.ID,q.SEQ_NO 
	</select>
	
	<select id="getQuestionnaireAnswerDetail" resultType="QuestionnaireAnswerModelBean">
		SELECT 
		ans.ID
		, hd.ID as HEADER_ID
		, ans.QUESTION_ID
		, q.QUESTION 
		, ans.ANSWER
		, ans.STATUS_CD
		, ans.SEQ_NO
		, ans.BU_ID
		, ans.CREATED_DATE
		, ans.CREATED_BY
		, ans.UPDATED_DATE
		, ans.UPDATED_BY
		FROM tb_questionnaire_ans_master ans
		join tb_questionnaire_q_master q on ans.QUESTION_ID = q.ID 
		join tb_questionnaire_header hd on q.HEADER_ID = hd.ID 
		where  hd.ID =#{headerId} and ans.ID=#{id}
		and hd.STATUS_CD ='Y' and q.STATUS_CD ='Y' and ans.STATUS_CD ='Y'
		order by ans.ID,hd.ID,q.SEQ_NO 
	</select>
	
	<select id="getQuestionnaireAnswerResultList" resultType="QuestionnaireAnswerModelBean">
		SELECT 
		    x.ID,
		    x.HEADER_ID,
		    GROUP_CONCAT(CONCAT(x.row_num, '. ', x.QUESTION, ': ', x.ANSWER) ORDER BY x.row_num ASC SEPARATOR '  \n') AS qAndA,
		    MAX(x.UPDATED_DATE) as updatedDate
		FROM (
		    SELECT 
		        ans.ID,
		        hd.ID as HEADER_ID ,
		        q.QUESTION,
		        ans.ANSWER,
		        @row_number := IF(@current_id = ans.ID, @row_number + 1, 1) AS row_num,
		        @current_id := ans.ID,
		        ans.UPDATED_DATE
		    FROM tb_questionnaire_ans_master ans
		    JOIN tb_questionnaire_q_master q ON ans.QUESTION_ID = q.ID 
		    JOIN tb_questionnaire_header hd ON q.HEADER_ID = hd.ID 
		    CROSS JOIN (SELECT @row_number := 0, @current_id := NULL) AS vars
		    WHERE hd.ID = #{headerId}
		    AND hd.STATUS_CD = 'Y' 
		    AND q.STATUS_CD = 'Y' 
		    AND ans.STATUS_CD = 'Y'
		    ORDER BY ans.ID, q.SEQ_NO
		) AS x
		GROUP BY x.ID,x.HEADER_ID
		ORDER BY x.ID
	</select>
	
	<select id="genQuestionnaireAnswerId" resultType="java.lang.Integer">
		SELECT 
		ifnull(ans.ID,0) as ID
		FROM tb_questionnaire_ans_master ans
		join tb_questionnaire_q_master q on ans.QUESTION_ID = q.ID 
		join tb_questionnaire_header hd on q.HEADER_ID = hd.ID 
		where  hd.ID =#{headerId} 
		and hd.STATUS_CD ='Y' and q.STATUS_CD ='Y' and ans.STATUS_CD ='Y'
		group by ans.ID
	</select>
	
	<insert id="createQuestionnareAnswer">
		INSERT INTO tb_questionnaire_ans_master
		(
			ID
			, QUESTION_ID
			, ANSWER
			, STATUS_CD
			, BU_ID
			, CREATED_DATE
			, CREATED_BY
			, UPDATED_DATE
			, UPDATED_BY
			)
			VALUES(
			#{id}
			, #{questionid}
			, #{answer}
			, #{statusCd}
			, #{buId}
			, NOW()
			, #{createdBy}
			, NOW()
			, #{updatedBy}
		)
	</insert>
	<update id="updateQuestionnaireAnswer">
		UPDATE tb_questionnaire_ans_master
		SET 
		ANSWER=#{answer}
		, STATUS_CD=#{statusCd}
		, UPDATED_DATE=NOW()
		, UPDATED_BY=#{updatedBy}
		WHERE ID=#{id}
		AND QUESTION_ID=#{questionId}
	</update>
	

	
</mapper>